{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">Resumo Resultados</h2>

<!-- üìå Filtros -->
<form method="GET" class="row g-3 mb-4">
    <div class="col-md-3">
        <input type="text" name="nome" class="form-control" placeholder="Nome (opcional)" value="{{ request.args.get('nome', '') }}">
    </div>
    <div class="col-md-3">
        <input type="text" name="cargo" class="form-control" placeholder="Cargo (opcional)" value="{{ request.args.get('cargo', '') }}">
    </div>
    <div class="col-md-3">
        <input type="date" name="data_inicial" class="form-control" value="{{ request.args.get('data_inicial', '') }}">
    </div>
    <div class="col-md-3">
        <input type="date" name="data_final" class="form-control" value="{{ request.args.get('data_final', '') }}">
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
</form>

<!-- üìå Bot√£o de Exportar para Excel -->
<form method="GET" action="{{ url_for('main.exportar_excel') }}" class="mb-4">
    <input type="hidden" name="nome" value="{{ request.args.get('nome', '') }}">
    <input type="hidden" name="cargo" value="{{ request.args.get('cargo', '') }}">
    <input type="hidden" name="data_inicial" value="{{ request.args.get('data_inicial', '') }}">
    <input type="hidden" name="data_final" value="{{ request.args.get('data_final', '') }}">
    <button type="submit" class="btn btn-outline-success">Exportar para Excel</button>
</form>

<!-- üìå Exibi√ß√£o da m√©dia geral -->
{% if media is not none %}
<p class="alert alert-info">M√©dia Geral do per√≠odo selecionado: <strong>{{ "%.2f" | format(media) }}%</strong></p>
{% else %}
<p class="alert alert-warning">Nenhum dado encontrado para o per√≠odo selecionado.</p>
{% endif %}

<!-- üìå Top 3 e Last 3 - Agora acima da tabela -->
<div class="row mt-5">
    <div class="col-md-6">
        <h3>Top 3</h3>
        <ul class="list-group">
            {% for item in top_3 %}
            <li class="list-group-item d-flex justify-content-between">
                {{ item.nome }} <span class="badge bg-success">{{ "%.2f" | format(item.media_refile) }}%</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="col-md-6">
        <h3>Last 3</h3>
        <ul class="list-group">
            {% for item in last_3 %}
            <li class="list-group-item d-flex justify-content-between">
                {{ item.nome }} <span class="badge bg-danger">{{ "%.2f" | format(item.media_refile) }}%</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- üìå Tabela com M√©dia por Funcion√°rio -->
<table class="table table-bordered mt-4" id="resumoTable">
    <thead class="table-dark">
        <tr>
            <th>Funcion√°rio</th>
            <th>Cargo</th>
            <th onclick="sortTableByRefile()" style="cursor: pointer;">
                M√©dia Refile (%) <span id="sortIcon">‚áÖ</span>
            </th>
        </tr>
    </thead>
    <tbody>
        {% for colaborador in medias_colaboradores %}
        <tr>
            <td>{{ colaborador.nome }}</td>
            <td>{{ colaborador.cargo }}</td>
            <td>
                <span style="height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 8px; background-color: 
                    {% if colaborador.media_refile >= 70 %} green 
                    {% elif 60 <= colaborador.media_refile < 70 %} yellow 
                    {% else %} red {% endif %};">
                </span>
                {{ "%.2f" | format(colaborador.media_refile) }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- JavaScript para ordena√ß√£o -->
<script>
let isAscending = true;

function sortTableByRefile() {
    const table = document.getElementById("resumoTable");
    const rows = Array.from(table.rows).slice(1); // Exclui o cabe√ßalho

    rows.sort((a, b) => {
        const refA = parseFloat(a.cells[2].innerText) || 0;
        const refB = parseFloat(b.cells[2].innerText) || 0;
        return isAscending ? refA - refB : refB - refA;
    });

    isAscending = !isAscending; // Alterna a ordena√ß√£o
    document.getElementById("sortIcon").innerText = isAscending ? "‚Üë" : "‚Üì";

    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
}
</script>

{% endblock %}
